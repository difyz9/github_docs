name: Build and Release to Target Repo

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      target_repo:
        description: 'Target repository (owner/repo)'
        required: false
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºæºç 
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. è®¾ç½®Node.jsç¯å¢ƒï¼ˆæ ¹æ®é¡¹ç›®ç±»å‹è°ƒæ•´ï¼‰
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
      if: hashFiles('package.json') != ''
    
    # 3. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: npm ci
      if: hashFiles('package.json') != ''
    
    # 4. æ„å»ºé¡¹ç›®
    - name: Build project
      run: npm run build
      if: hashFiles('package.json') != ''
    
    # 5. åˆ›å»ºå‘å¸ƒåŒ…
    - name: Create release package
      run: |
        # ç¡®å®šç‰ˆæœ¬å·
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release-package
        
        # å¤åˆ¶æ„å»ºäº§ç‰©ï¼ˆæ ¹æ®å®é™…é¡¹ç›®è°ƒæ•´è·¯å¾„ï¼‰
        if [ -d "dist" ]; then
          cp -r dist/* release-package/
        elif [ -d "build" ]; then
          cp -r build/* release-package/
        elif [ -d "out" ]; then
          cp -r out/* release-package/
        else
          echo "No build output found!"
          exit 1
        fi
        
        # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        echo "{\"version\":\"$VERSION\",\"build_date\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"commit\":\"$GITHUB_SHA\"}" > release-package/build-info.json
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd release-package
        zip -r ../release.zip .
        tar -czf ../release.tar.gz .
        cd ..
        
        # è¾“å‡ºæ–‡ä»¶ä¿¡æ¯
        echo "Release package contents:"
        ls -la release-package/
        echo "Archive files:"
        ls -lh release.zip release.tar.gz
    
    # 6. å‘å¸ƒåˆ°ç›®æ ‡ä»“åº“
    - name: Create release in target repository
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        TARGET_REPO: ${{ secrets.TARGET_REPO || github.event.inputs.target_repo }}
      run: |
        # éªŒè¯ç›®æ ‡ä»“åº“é…ç½®
        if [ -z "$TARGET_REPO" ]; then
          echo "Error: TARGET_REPO not configured"
          exit 1
        fi
        
        echo "Creating release in repository: $TARGET_REPO"
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜
        RELEASE_NOTES="## Release $VERSION

### ğŸ“¦ Build Information
- **Source Repository**: ${{ github.repository }}
- **Source Commit**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
- **Build Date**: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)
- **Workflow**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

### ğŸ“¥ Downloads
- **release.zip**: Universal zip archive
- **release.tar.gz**: Unix/Linux tar.gz archive

### âœ¨ What's Included
- Built and optimized production files
- Build metadata (build-info.json)

---
*This release was automatically created from [${{ github.repository }}](https://github.com/${{ github.repository }}) by GitHub Actions.*"
        
        # ä½¿ç”¨GitHub CLIåˆ›å»ºrelease
        gh release create "$VERSION" \
          --repo "$TARGET_REPO" \
          --title "Release $VERSION" \
          --notes "$RELEASE_NOTES" \
          release.zip \
          release.tar.gz
        
        echo "âœ… Release created successfully!"
        echo "ğŸ”— View at: https://github.com/$TARGET_REPO/releases/tag/$VERSION"
