name: Build and Release

# è§¦å‘æ¡ä»¶ï¼šå½“æŽ¨é€tagæ—¶è‡ªåŠ¨è¿è¡Œ
on:
  push:
    tags:
      - 'v*'  # åŒ¹é…æ‰€æœ‰ä»¥vå¼€å¤´çš„tagï¼Œå¦‚v1.0.0

  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºrelease
      
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽç”Ÿæˆchangelog
    
    # 2. è®¾ç½®Node.jsçŽ¯å¢ƒ (å¦‚æžœæ˜¯Node.jsé¡¹ç›®)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
      if: hashFiles('package.json') != ''
    
    # 3. è®¾ç½®PythonçŽ¯å¢ƒ (å¦‚æžœæ˜¯Pythoné¡¹ç›®)
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
      if: hashFiles('setup.py', 'pyproject.toml') != ''
    
    # 4. è®¾ç½®GoçŽ¯å¢ƒ (å¦‚æžœæ˜¯Goé¡¹ç›®)
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
      if: hashFiles('go.mod') != ''
    
    # 5. å®‰è£…ä¾èµ–å’Œæž„å»º (Node.js)
    - name: Install dependencies and build (Node.js)
      if: hashFiles('package.json') != ''
      run: |
        npm ci
        npm run build --if-present
    
    # 6. æž„å»º (Go)
    - name: Build (Go)
      if: hashFiles('go.mod') != ''
      run: |
        mkdir -p dist
        go build -o dist/ ./...
    
    # 7. æž„å»º (Python)
    - name: Build (Python)
      if: hashFiles('setup.py', 'pyproject.toml') != ''
      run: |
        python -m pip install build
        python -m build
        mkdir -p dist
        cp dist/*.whl dist/*.tar.gz dist/ 2>/dev/null || true
    
    # 8. åˆ›å»ºåŽ‹ç¼©åŒ…
    - name: Create release archive
      run: |
        # ç¡®å®šè¦æ‰“åŒ…çš„ç›®å½•
        if [ -d "dist" ]; then
          ARCHIVE_DIR="dist"
        elif [ -d "build" ]; then
          ARCHIVE_DIR="build"
        elif [ -d "out" ]; then
          ARCHIVE_DIR="out"
        else
          echo "No build directory found, creating one with current directory contents"
          mkdir -p dist
          # å¤åˆ¶é‡è¦æ–‡ä»¶åˆ°distç›®å½•
          cp -r . dist/ 2>/dev/null || true
          # æŽ’é™¤ä¸€äº›ä¸éœ€è¦çš„æ–‡ä»¶/ç›®å½•
          rm -rf dist/.git dist/node_modules dist/.github dist/.gitignore 2>/dev/null || true
          ARCHIVE_DIR="dist"
        fi
        
        # åˆ›å»ºåŽ‹ç¼©åŒ…
        zip -r release.zip $ARCHIVE_DIR
        
        # åˆ›å»ºtar.gzæ ¼å¼çš„åŽ‹ç¼©åŒ…
        tar -czf release.tar.gz $ARCHIVE_DIR
        
        echo "ARCHIVE_DIR=$ARCHIVE_DIR" >> $GITHUB_ENV
    
    # 9. ç”Ÿæˆchangelog
    - name: Generate changelog
      id: changelog
      run: |
        # èŽ·å–ç‰ˆæœ¬å·
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        # ç”Ÿæˆchangelog
        CHANGELOG="## Release $VERSION

### ðŸ“¦ What's Included
- Built artifacts ready for deployment
- Source code snapshot

### ðŸ”„ Changes"
        
        # èŽ·å–ä¸Šä¸€ä¸ªtag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREV_TAG" ]; then
          CHANGELOG="$CHANGELOG
$(git log --pretty=format:'- %s (%h)' $PREV_TAG..HEAD)"
        else
          CHANGELOG="$CHANGELOG
- Initial release"
        fi
        
        CHANGELOG="$CHANGELOG

### ðŸ“… Release Information
- **Version:** $VERSION
- **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
- **Commit:** ${GITHUB_SHA:0:7}
- **Archives:** release.zip, release.tar.gz

### ðŸ“¥ Download
Choose the format that works best for you:
- **ZIP:** Suitable for Windows and general use
- **TAR.GZ:** Suitable for Unix/Linux systems

---
*This release was created automatically by GitHub Actions.*"
        
        # ä¿å­˜changelogåˆ°æ–‡ä»¶
        echo "$CHANGELOG" > changelog.md
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    # 10. åˆ›å»ºGitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: Release ${{ env.VERSION }}
        body: ${{ steps.changelog.outputs.changelog }}
        files: |
          release.zip
          release.tar.gz
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # 11. è¾“å‡ºç»“æžœ
    - name: Output release info
      run: |
        echo "âœ… Release created successfully!"
        echo "ðŸ”— View at: https://github.com/${{ github.repository }}/releases/tag/${{ env.VERSION }}"
        echo "ðŸ“¦ Archive contents: ${{ env.ARCHIVE_DIR }}"
        echo "ðŸ“Š Archive sizes:"
        ls -lh release.zip release.tar.gz
